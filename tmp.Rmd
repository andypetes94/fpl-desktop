---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 


```{r}
library(readr)

# Path to your Shiny app folder
app_dir <- "~/Desktop/Shiny_Apps/Old_FPL/25_26/"

# List common text-based files
files <- list.files(
  app_dir,
  pattern = "\\.(R|r|Rmd|csv|tsv|txt|json|html|md)$",
  recursive = TRUE,
  full.names = TRUE
)

# Check encoding for each file
encodings <- lapply(files, function(f) {
  enc <- readr::guess_encoding(f, n_max = 1000)  # inspect first 1000 bytes
  data.frame(
    file = f,
    encoding = enc$encoding[1],
    confidence = enc$confidence[1],
    stringsAsFactors = FALSE
  )
})

encodings_df <- do.call(rbind, encodings)
encodings_df

```



```{r}

team_id <- '18148'

FPL_Team <- GET(paste0('https://fantasy.premierleague.com/api/entry/', team_id, '/history/'))
    
    
    jsonRespText<-content(FPL_Team, as="text") 
    JSON_Output <- fromJSON(jsonRespText)
    
    Chips <- JSON_Output$chips %>%
      select(-time)
    
    temp_df <- team_picks_parse(team_id, 27) %>%
      left_join(Chips, by = c('event')) %>%
      rename(chip = name) %>%
      mutate(chip_short = case_when(chip == 'wildcard' ~ 'WC',
                                    chip == 'freehit' ~ 'FH',
                                    chip == 'bboost' ~ 'BB',
                                    chip == '3xc' ~ 'TC',
                                    chip == 'manager' ~ 'AM',
                                    T ~''))
    
```


```{r}


output$scatter_plot <- renderPlotly({
  
  
  player_highlight <- input$players
  
  df <- create_table1(Players_History, input$positions, input$gameweeks[1], input$gameweeks[2], input$starts_1, input$calculations, input$value) %>%
    mutate(team_colour = case_when(Team == "ARS" ~ "#EF0107",
                                   Team == "AVL" ~ "#670E36",
                                   Team == "BOU" ~ "#B50E12",
                                   Team == "BRE" ~ "#E30613",
                                   Team == "BHA" ~ "#0057B8",
                                   Team == "BUR" ~ "#6C1D45",
                                   Team == "CHE" ~ "#034694",
                                   Team == "CRY" ~ "#1B458F",
                                   Team == "EVE" ~ "#003399",
                                   Team == "FUL" ~ "#000000",
                                   Team == "LIV" ~ "#C8102E",
                                   Team == "LUT" ~ "#F78F1E",
                                   Team == "MCI" ~ "#6CABDD",
                                   Team == "MUN" ~ "#DA291C",
                                   Team == "NEW" ~ "#241F20",
                                   Team == "NFO" ~ "#DD0000",
                                   Team == "SHU" ~ "#EE2737",
                                   Team == "TOT" ~ "#132257",
                                   Team == "WHU" ~ "#7A263A",
                                   Team == "WOL" ~ "#FDB913")) %>%
    mutate(final_colour = case_when(Player %in% player_highlight ~ team_colour,
                                    T ~ "gray")) %>%
    mutate(Tooltip = paste0("\n\nPlayer: ", Player, "\n",input$scatter_x, ": ", get(input$scatter_x), "\n",input$scatter_y, ": ", get(input$scatter_y)))
  
  small_df <- df %>%
    filter(final_colour != "gray")
  
  
  p <- ggplot(df, aes(x = get(input$scatter_x), y = get(input$scatter_y))) +
    geom_point(data = df %>% filter(final_colour == "gray"), aes(label = Tooltip), shape = 21, stroke = 1, size = 3, color = "#F3E9E2", fill = "gray", alpha = 0.5) +
    geom_text_repel(data = df %>% filter(final_colour != "gray"), aes(label = Player, colour = Player), size = 3, bg.color = "#F3E9E2",bg.r = .15, family = "Bahnschrift", min.segment.length = unit(0, 'lines'), segment.curvature = -0.1, segment.ncp = 3, segment.angle = 20, nudge_x =  0.15, nudge_y = 0.35, show.legend = F) +
    geom_point(data = df %>% filter(final_colour != "gray"), size = 5.5, color = "white", alpha = 0.5, show.legend = F) +
    geom_point(data = df %>% filter(final_colour != "gray"), aes(fill = Player, label = Tooltip), shape = 21, stroke = 0.5, size = 4, color = "white", alpha = 0.8, show.legend = F) +
    geom_hline(yintercept = 0, color = "gray30", size = 0.75) +
    scale_fill_manual(values = small_df$team_colour,
                      breaks = small_df$Player) +#
    scale_colour_manual(values = small_df$team_colour,
                        breaks = small_df$Player) +
    coord_cartesian(clip = "off") +
    xlab(input$scatter_x) +
    ylab(input$scatter_y) +
    #labs(#title =  paste0("Captaincy Success (ID: ", id, ")"),
    #  title =  paste0(input$scatter_x, " Vs. ", input$scatter_y, ": GW", input$gameweeks[1], " - ", input$gameweeks[2]),
    #  caption = "Data Taken From FPL Website | Follow @Data_Vizard_") +
    #Adjust Theme to suit this plot
    theme(panel.grid.major.x = element_line(color = "white", linewidth = 0.50, linetype = "dashed"),
          #panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_line(color = "white", linewidth = 0.50),
          #panel.grid.major.y = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.border = element_blank(),
          panel.spacing = unit(0.5, "lines"),
          #panel.border = element_rect(colour = 'gray30', fill = NA, size = 2),
          legend.position = "top",
          panel.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
          plot.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
          #plot.title = element_markdown(color = "black", size = 24, family = "Bahnschrift"),
          plot.title = element_text(color = "black", size = 24, family = "Bahnschrift"),
          plot.caption = element_text(color = "black", size = 10, family = "Bahnschrift"),
          plot.subtitle = element_markdown(size = 16, color = "gray30", family = "Bahnschrift", hjust = 0.19),
          legend.text = element_text(color = "gray20", size = 12, family = "Bahnschrift", hjust = 0),
          legend.title = element_blank(),
          legend.key = element_blank(),
          legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(-10,-10,-10,-10),
          axis.text.x = element_text(color ="black", size = 12, family = "Bahnschrift"),
          axis.text.y = element_text(color ="black", size = 12, family = "Bahnschrift", vjust = -0.3, hjust = 1),
          #axis.text.y = element_markdown(size = 6, color = 'black', family = "Bahnschrift", hjust = 1),
          axis.title.x = element_text(color = "black", size = 12,  family = "Bahnschrift"),
          axis.title.y = element_text(color = "black", size = 12,  family = "Bahnschrift"),
          #axis.ticks.length.x = unit(0.1, "cm"),
          axis.ticks.x = element_blank(),
          #axis.ticks.length.y = element_blank(),
          axis.ticks.y = element_blank(),
          axis.line.x = element_blank(),
          axis.line.y = element_line(color = "gray30", size = 0.75),
          strip.background = element_blank(),
          strip.text.x = element_markdown(color = "gray20", size = 12, family = "Bahnschrift"),
          strip.text.y.left = element_markdown(color = "gray20", size = 10, family = "Bahnschrift", angle = 360, vjust = 0),
          legend.background = element_blank())
  
  #p
  ggplotly(p, tooltip = "label") #%>%
  #  plot_ly(hovertemplate = paste(
  #    "<b>%{text}</b><br><br>",
  #    "%{yaxis.title.text}: %{y:.2f}<br>",
  #    "%{xaxis.title.text}: %{x:.2f}<br>",
  #    "Player: %{Player}",
  #    "<extra></extra>"
  #  ))
    
  
})


output$download_scatter <- downloadHandler(
  filename = function(){paste("FPL.Scatter.", input$positions, ".GW", input$gameweeks[1] , "_GW", input$gameweeks[2],".png", sep='')},
  
  
  content = function(file){
    
    player_highlight <- input$players
    
    df <- create_table1(Players_History, input$positions, input$gameweeks[1], input$gameweeks[2], input$starts_1, input$calculations, input$value) %>%
      mutate(team_colour = case_when(Team == "ARS" ~ "#EF0107",
                                     Team == "AVL" ~ "#670E36",
                                     Team == "BOU" ~ "#B50E12",
                                     Team == "BRE" ~ "#E30613",
                                     Team == "BHA" ~ "#0057B8",
                                     Team == "BUR" ~ "#6C1D45",
                                     Team == "CHE" ~ "#034694",
                                     Team == "CRY" ~ "#1B458F",
                                     Team == "EVE" ~ "#003399",
                                     Team == "FUL" ~ "#000000",
                                     Team == "LIV" ~ "#C8102E",
                                     Team == "LUT" ~ "#F78F1E",
                                     Team == "MCI" ~ "#6CABDD",
                                     Team == "MUN" ~ "#DA291C",
                                     Team == "NEW" ~ "#241F20",
                                     Team == "NFO" ~ "#DD0000",
                                     Team == "SHU" ~ "#EE2737",
                                     Team == "TOT" ~ "#132257",
                                     Team == "WHU" ~ "#7A263A",
                                     Team == "WOL" ~ "#FDB913")) %>%
      mutate(final_colour = case_when(Player %in% player_highlight ~ team_colour,
                                      T ~ "gray")) %>%
      mutate(Tooltip = paste0("\n\nPlayer: ", Player, "\n",input$scatter_x, ": ", get(input$scatter_x), "\n",input$scatter_y, ": ", get(input$scatter_y)))
    
    small_df <- df %>%
      filter(final_colour != "gray")
    
    
    p <- ggplot(df, aes(x = get(input$scatter_x), y = get(input$scatter_y))) +
      geom_point(data = df %>% filter(final_colour == "gray"), aes(label = Tooltip), shape = 21, stroke = 1, size = 3, color = "#F3E9E2", fill = "gray", alpha = 0.5) +
      geom_text_repel(data = df %>% filter(final_colour != "gray"), aes(label = Player, colour = Player), size = 3, bg.color = "#F3E9E2",bg.r = .15, family = "Bahnschrift", min.segment.length = unit(0, 'lines'), segment.curvature = -0.1, segment.ncp = 3, segment.angle = 20, nudge_x =  0.15, nudge_y = 0.35, show.legend = F) +
      geom_point(data = df %>% filter(final_colour != "gray"), size = 5.5, color = "white", alpha = 0.5, show.legend = F) +
      geom_point(data = df %>% filter(final_colour != "gray"), aes(fill = Player, label = Tooltip), shape = 21, stroke = 0.5, size = 4, color = "white", alpha = 0.8, show.legend = F) +
      geom_hline(yintercept = 0, color = "gray30", size = 0.75) +
      scale_fill_manual(values = small_df$team_colour,
                        breaks = small_df$Player) +#
      scale_colour_manual(values = small_df$team_colour,
                          breaks = small_df$Player) +
      coord_cartesian(clip = "off") +
      xlab(input$scatter_x) +
      ylab(input$scatter_y) +
      labs(#title =  paste0("Captaincy Success (ID: ", id, ")"),
        title =  paste0("<img src='./Logo4.png' width='30'> ", input$scatter_x, " Vs. ", input$scatter_y, ": GW", input$gameweeks[1], " - ", input$gameweeks[2]),
        caption = "Data Taken From FPL Website | Follow @Data_Vizard_<img src='./Logo4.png' width='13'>") +
      #Adjust Theme to suit this plot
      theme(panel.grid.major.x = element_line(color = "white", linewidth = 0.50, linetype = "dashed"),
            #panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_line(color = "white", linewidth = 0.50),
            #panel.grid.major.y = element_blank(),
            panel.grid.minor.x = element_blank(),
            panel.grid.minor.y = element_blank(),
            panel.border = element_blank(),
            panel.spacing = unit(0.5, "lines"),
            #panel.border = element_rect(colour = 'gray30', fill = NA, size = 2),
            legend.position = "top",
            panel.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
            plot.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
            #plot.title = element_markdown(color = "black", size = 24, family = "Bahnschrift"),
            plot.title = element_markdown(color = "black", size = 24, family = "Bahnschrift"),
            plot.caption = element_markdown(color = "black", size = 10, family = "Bahnschrift"),
            plot.subtitle = element_markdown(size = 16, color = "gray30", family = "Bahnschrift", hjust = 0.19),
            legend.text = element_text(color = "gray20", size = 12, family = "Bahnschrift", hjust = 0),
            legend.title = element_blank(),
            legend.key = element_blank(),
            legend.margin=margin(0,0,0,0),
            legend.box.margin=margin(-10,-10,-10,-10),
            axis.text.x = element_text(color ="black", size = 12, family = "Bahnschrift"),
            axis.text.y = element_text(color ="black", size = 12, family = "Bahnschrift", vjust = -0.3, hjust = 1),
            #axis.text.y = element_markdown(size = 6, color = 'black', family = "Bahnschrift", hjust = 1),
            axis.title.x = element_text(color = "black", size = 12,  family = "Bahnschrift"),
            axis.title.y = element_text(color = "black", size = 12,  family = "Bahnschrift"),
            #axis.ticks.length.x = unit(0.1, "cm"),
            axis.ticks.x = element_blank(),
            #axis.ticks.length.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_line(color = "gray30", size = 0.75),
            strip.background = element_blank(),
            strip.text.x = element_markdown(color = "gray20", size = 12, family = "Bahnschrift"),
            strip.text.y.left = element_markdown(color = "gray20", size = 10, family = "Bahnschrift", angle = 360, vjust = 0),
            legend.background = element_blank())
    
    #p
    #ggplot(p, tooltip = "label") #%>%
    

    ggsave(file, plot = p, dpi = 600, height = 6, width = 10)
    
    
  })

output$download_scatter_html <- downloadHandler(
  filename = function(){paste("FPL.Scatter.", input$positions, ".GW", input$gameweeks[1] , "_GW", input$gameweeks[2],".html", sep='')},
  
  
  content = function(file){
    
    player_highlight <- input$players
    
    df <- create_table1(Players_History, input$positions, input$gameweeks[1], input$gameweeks[2], input$starts_1, input$calculations, input$value) %>%
      mutate(team_colour = case_when(Team == "ARS" ~ "#EF0107",
                                     Team == "AVL" ~ "#670E36",
                                     Team == "BOU" ~ "#B50E12",
                                     Team == "BRE" ~ "#E30613",
                                     Team == "BHA" ~ "#0057B8",
                                     Team == "BUR" ~ "#6C1D45",
                                     Team == "CHE" ~ "#034694",
                                     Team == "CRY" ~ "#1B458F",
                                     Team == "EVE" ~ "#003399",
                                     Team == "FUL" ~ "#000000",
                                     Team == "LIV" ~ "#C8102E",
                                     Team == "LUT" ~ "#F78F1E",
                                     Team == "MCI" ~ "#6CABDD",
                                     Team == "MUN" ~ "#DA291C",
                                     Team == "NEW" ~ "#241F20",
                                     Team == "NFO" ~ "#DD0000",
                                     Team == "SHU" ~ "#EE2737",
                                     Team == "TOT" ~ "#132257",
                                     Team == "WHU" ~ "#7A263A",
                                     Team == "WOL" ~ "#FDB913")) %>%
      mutate(final_colour = case_when(Player %in% player_highlight ~ team_colour,
                                      T ~ "gray")) %>%
      mutate(Tooltip = paste0("\n\nPlayer: ", Player, "\n",input$scatter_x, ": ", get(input$scatter_x), "\n",input$scatter_y, ": ", get(input$scatter_y)))
    
    small_df <- df %>%
      filter(final_colour != "gray")
    
    
    p <- ggplot(df, aes(x = get(input$scatter_x), y = get(input$scatter_y))) +
      geom_point(data = df %>% filter(final_colour == "gray"), aes(label = Tooltip), shape = 21, stroke = 1, size = 3, color = "#F3E9E2", fill = "gray", alpha = 0.5) +
      geom_text_repel(data = df %>% filter(final_colour != "gray"), aes(label = Player, colour = Player), size = 3, bg.color = "#F3E9E2",bg.r = .15, family = "Bahnschrift", min.segment.length = unit(0, 'lines'), segment.curvature = -0.1, segment.ncp = 3, segment.angle = 20, nudge_x =  0.15, nudge_y = 0.35, show.legend = F) +
      geom_point(data = df %>% filter(final_colour != "gray"), size = 5.5, color = "white", alpha = 0.5, show.legend = F) +
      geom_point(data = df %>% filter(final_colour != "gray"), aes(fill = Player, label = Tooltip), shape = 21, stroke = 0.5, size = 4, color = "white", alpha = 0.8, show.legend = F) +
      geom_hline(yintercept = 0, color = "gray30", size = 0.75) +
      scale_fill_manual(values = small_df$team_colour,
                        breaks = small_df$Player) +#
      scale_colour_manual(values = small_df$team_colour,
                          breaks = small_df$Player) +
      coord_cartesian(clip = "off") +
      xlab(input$scatter_x) +
      ylab(input$scatter_y) +
      labs(#title =  paste0("Captaincy Success (ID: ", id, ")"),
        title =  paste0(input$scatter_x, " Vs. ", input$scatter_y, ": GW", input$gameweeks[1], " - ", input$gameweeks[2]),
        caption = "Data Taken From FPL Website | Follow @Data_Vizard_") +
      #Adjust Theme to suit this plot
      theme(panel.grid.major.x = element_line(color = "white", linewidth = 0.50, linetype = "dashed"),
            #panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_line(color = "white", linewidth = 0.50),
            #panel.grid.major.y = element_blank(),
            panel.grid.minor.x = element_blank(),
            panel.grid.minor.y = element_blank(),
            panel.border = element_blank(),
            panel.spacing = unit(0.5, "lines"),
            #panel.border = element_rect(colour = 'gray30', fill = NA, size = 2),
            legend.position = "top",
            panel.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
            plot.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
            #plot.title = element_markdown(color = "black", size = 24, family = "Bahnschrift"),
            plot.title = element_text(color = "black", size = 24, family = "Bahnschrift"),
            plot.caption = element_text(color = "black", size = 10, family = "Bahnschrift"),
            plot.subtitle = element_markdown(size = 16, color = "gray30", family = "Bahnschrift", hjust = 0.19),
            legend.text = element_text(color = "gray20", size = 12, family = "Bahnschrift", hjust = 0),
            legend.title = element_blank(),
            legend.key = element_blank(),
            legend.margin=margin(0,0,0,0),
            legend.box.margin=margin(-10,-10,-10,-10),
            axis.text.x = element_text(color ="black", size = 12, family = "Bahnschrift"),
            axis.text.y = element_text(color ="black", size = 12, family = "Bahnschrift", vjust = -0.3, hjust = 1),
            #axis.text.y = element_markdown(size = 6, color = 'black', family = "Bahnschrift", hjust = 1),
            axis.title.x = element_text(color = "black", size = 12,  family = "Bahnschrift"),
            axis.title.y = element_text(color = "black", size = 12,  family = "Bahnschrift"),
            #axis.ticks.length.x = unit(0.1, "cm"),
            axis.ticks.x = element_blank(),
            #axis.ticks.length.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_line(color = "gray30", size = 0.75),
            strip.background = element_blank(),
            strip.text.x = element_markdown(color = "gray20", size = 12, family = "Bahnschrift"),
            strip.text.y.left = element_markdown(color = "gray20", size = 10, family = "Bahnschrift", angle = 360, vjust = 0),
            legend.background = element_blank())
    
    #p
    #ggplot(p, tooltip = "label") #%>%
    
    fig <- ggplotly(p, tooltip = "label")
    
    htmlwidgets::saveWidget(
      widget = fig, #the plotly object
      file = file, #the path & file name
      selfcontained = TRUE #creates a single html file
    )
    
    #ggsave(file, plot = p, dpi = 600, height = 6, width = 10)
    
    
  })


```



####### FPL Gallagher ########
####### Captaincy ########

```{r}

Players_History <- read.csv('./24_25/Players_History.csv') 

FPL_ID <- 

FPL_Team <- GET(paste0('https://fantasy.premierleague.com/api/entry/', FPL_ID, '/history/'))
    
    
    jsonRespText<-content(FPL_Team, as="text") 
    JSON_Output <- fromJSON(jsonRespText)
    
    Chips <- JSON_Output$chips %>%
      select(-time)
    
    
FPL_Team <- GET(paste0('https://fantasy.premierleague.com/api/entry/', FPL_ID,'/'))
    
    jsonRespText<-content(FPL_Team, as="text") 
    JSON_Output <- fromJSON(jsonRespText)
    Team_Name <- JSON_Output$name %>% data.frame() %>% pull(.)
    Manager <- paste0(JSON_Output$player_first_name, " ", JSON_Output$player_last_name) %>% data.frame() %>% pull(.)
    
    
    Team_Selection_Final <- captaincy_parse(FPL_ID, Players_History, max(Players_History$round)) %>%
      left_join(Chips, by = c('round' = 'event')) %>%
      rename(chip = name) %>%
      mutate(chip_short = case_when(chip == 'wildcard' ~ 'WC',
                                    chip == 'freehit' ~ 'FH',
                                    chip == 'bboost' ~ 'BB',
                                    chip == '3xc' ~ 'TC',
                                    chip == 'manager' ~ 'AM',
                                    T ~'')) %>%
      mutate(GW_Chip = paste(round,"\n",chip_short)) %>%
      mutate(GW_Chip = str_replace(GW_Chip, " ","")) %>%
      separate(name_club, sep = " " ,c("name","club")) %>%
      mutate(name_info = paste0(name, "\n(",oppsition,")")) %>%
      mutate(img_labels = paste0("<img src='", player_images,  "' width='20' /><br>", label2)) %>%
      mutate(img_labels = str_replace_all(img_labels, ",", "<br>"))
    
    small_df2 <- Team_Selection_Final %>%
      group_by(round) %>%
      summarise(chip = unique(chip)) %>%
      ungroup() %>%
      filter(!is.na(chip))
    
    
    round1 <- Team_Selection_Final$round
    gw <- Team_Selection_Final$GW_Chip
    
```



```{r}

data <- Team_Selection_Final
  
  p <- ggplot(data %>% filter(played_captain == "Yes") %>% mutate(line_color = lead(total_points)), aes(x = reorder(img_labels, round), y = total_points)) +
    #geom_vline(data = small_df2, aes(xintercept = round), color = "lightgray", size = 9) +
    geom_bar(aes(fill = as.factor(captaincy)), stat = "identity", color = NA, width = 0.8) +
    #geom_segment(aes(x = round, xend = round, y = 0, yend = total_points, color = as.factor(captaincy)), size = 5) +
    #geom_point(aes(color = as.factor(captaincy), fill = as.factor(captaincy)), shape = 21, stroke = 1.5, size = 6, color = "#F3E9E2") +
    geom_text(aes(label = total_points, color = as.factor(captaincy)), size = 5, family = "Lato", fontface = "bold", nudge_y = 1, show.legend = F) +
    #geom_shadowtext(aes(label = name_info), family = "Lato", size = 2.2, color = "black", bg.colour = "#F3E9E2", bg.r = 0.02, nudge_y = 1.3, lineheight = .9) +
    scale_color_manual(breaks = c("Double Digits","Success","Fail"),
                       values = c("#0B775E",'#66C2A5','#F2055C')) +
                       #values = c('#006BA2','#DB444B','#379A8B')) +
    scale_fill_manual(breaks = c("Double Digits","Success","Fail"),
                       values = c("#0B775E",'#66C2A5','#F2055C')) +
                      #values = c('#006BA2','#DB444B','#379A8B')) + 
    coord_cartesian(clip = "off") +
    #scale_x_discrete(name = NULL, labels = setNames(as.character(Team_Selection_Final$label1),round)) +
    scale_x_discrete(name = NULL, labels = setNames(as.character(gw),as.character(round1))) +
    scale_y_continuous(expand = c(0, 0)) +
    labs(#title =  paste0("Captaincy Success (ID: ", id, ")"),
      title =  paste0("<img src='./Logo4.png' width='30'>", " Captaincy Success - ", Team_Name ),
      subtitle = "Points for Captained Players",
      caption = "Data Taken From FPL Website | Follow @Data_Vizard_<img src='./Logo4.png' width='13'>",
      fill = "Captaincy Success",
      color = "Captaincy Success") +
    xlab("Gameweek") +
    ylab("Captaincy Points") +
    #Adjust Theme to suit this plot
    theme(panel.grid.major.x = element_blank(),
          #panel.grid.major.x = element_blank(),
          #panel.grid.major.y = element_line(color = "lightgray", linewidth = 0.5),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.border = element_blank(),
          panel.spacing = unit(0.5, "lines"),
          #panel.border = element_rect(colour = 'gray30', fill = NA, size = 2),
          legend.position = "top",
          panel.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
          plot.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
          plot.title = element_markdown(color = "black", size = 30, family = "Lato", face = "bold"),
          plot.caption = element_markdown(color = "black", size = 10, family = "Lato"),
          plot.subtitle = element_markdown(size = 22, color = "gray30", family = "Lato"),
          legend.text = element_text(color = "gray20", size = 16, family = "Lato", hjust = 0),
          legend.title = element_blank(),
          legend.key = element_blank(),
          legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(0,0,0,0),
          #axis.text.x = element_markdown(color ="black", size = 6, family = "Lato"),
          axis.text.x = element_markdown(color ="black", size = 6, family = "Lato", face = "bold"),
          #axis.text.y = element_text(color ="black", size = 12, family = "Lato", vjust = -0.3, hjust = 1),
          axis.text.y = element_blank(),
          axis.title.x = element_text(color = "black", size = 12,  family = "Lato"),
          axis.title.y = element_blank(),
          axis.ticks.length.x = unit(0.1, "cm"),
          axis.ticks.x = element_blank(),
          axis.ticks.length.y = unit(0.1, "cm"),
          axis.ticks.y = element_blank(),
          axis.line.x = element_line(color = "gray20", linewidth = 0.75),
          axis.line.y = element_blank(),
          strip.background = element_blank(),
          strip.text.x = element_markdown(color = "gray20", size = 12, family = "Lato"),
          strip.text.y.left = element_markdown(color = "gray20", size = 10, family = "Lato", angle = 360, vjust = 0),
          legend.background = element_blank())
  
  
  p
  
  ggsave(filename = '/Users/andrewpeters/Desktop/FPL/FPL_Gallagher/captaincy2.png', plot = p, dpi = 600, height = 6, width = 10)
  
```


```{r}
library(ggtext)

davitts_df <- data.frame(score_types = c("Point", "2-Pointer","Goal","Miss"),
                         score_value = c(5,0,1,5,2,0,0,2,0,0,1,3,2,0,0,0),
                         Player = c("Dylan","Dylan","Dylan","Dylan","Cathal","Cathal","Cathal","Cathal","Jack","Jack","Jack","Jack","Shane","Shane","Shane","Shane")) 

davitts_df$Player <- factor(davitts_df$Player, levels = c("Dylan","Cathal","Jack","Shane"))

davitts_df$score_types <- factor(davitts_df$score_types, levels = c("Point", "2-Pointer","Goal","Miss"))

# Convert to tile coordinates
waffle_coords <- waffle_iron(davitts_df, aes_d(fill = score_value, group = Player), rows = 11)

# davitts_df <- bind_cols(davitts_df, waffle_coords) %>%
#   mutate(score_text = case_when(score_types == "Point" ~ "1",
#                                 score_types == "2-Pointer" ~ "2",
#                                 score_types == "Goal" ~ "3",
#                                 score_types == "Miss" ~ NA,
#                                 T ~ NA))

count_df <- davitts_df %>%
  mutate(id = row_number()) %>%
  uncount(score_value) %>%
  group_by(id) %>%
  mutate(increment = row_number()) %>%
  ungroup() %>%
  group_by(Player) %>%
  mutate(increment_final = row_number()) %>%
  ungroup() %>%
  mutate(score_text = case_when(score_types == "Point" ~ "1",
                                score_types == "2-Pointer" ~ "2",
                                score_types == "Goal" ~ "3",
                                score_types == "Miss" ~ NA,
                                T ~ NA)) %>%
  # Create empty score value variable
  mutate(score_value = NA)


```


```{r}

library(ggplot2)
library(waffle)

p <- ggplot(davitts_df, aes(fill = score_types, values = score_value)) +
  geom_waffle(n_rows = 11, size = 1.5, colour = "white") +
  coord_equal() +
  facet_wrap(~Player, nrow = 1, strip.position = "bottom") +
  scale_fill_manual(breaks = c("Point", "2-Pointer","Goal","Miss"),
                                       values = c("#3EBCD2","#FF8C42",'#379A8B',"lightgray")) +
  geom_text(data = count_df, aes(x = 1, y = increment_final, label = score_text), 
            color = "black", family = "Lato", fontface = "bold", size = 4.5) +
  labs(title = paste0("<img src='/Users/andrewpeters/Desktop/Football_Projects/Davitts/Davitts_Crest.png' width='30'>", "Davitts Vs. Parke", "<img src='/Users/andrewpeters/Desktop/Football_Projects/Davitts/Parke.png' width='30'>"),
       subtitle = "Shots taken by Davitts GAA Players") +
  theme_void() +
  theme(panel.background = element_rect(color = "white", fill = "white"),
        plot.background = element_rect(color = "white", fill = "white"),
        panel.spacing = unit(4, "lines"),
        plot.title = element_markdown(color = "black", size = 28, family = "Lato", face = "bold"),
        plot.caption = element_markdown(color = "black", size = 10, family = "Lato"),
        plot.subtitle = element_text(size = 16, color = "gray30", family = "Lato"),
        strip.text = element_text(color = "gray20", size = 16, family = "Lato", margin = margin(t = -5, r = 0, b = 5, l = 0)),
        strip.clip = "off",
        # Legend
        legend.text = element_text(color = "gray20", size = 12, family = "Lato", hjust = 0),
        legend.title = element_blank(),
        legend.key = element_blank(),
        legend.margin=margin(10,0,-5,0),
        legend.box.margin=margin(0,0,-5,0),
        legend.position = "top")

p

ggsave(filename = '/Users/andrewpeters/Desktop/Football_Projects/Davitts/Points.png', plot = p, dpi = 600, height = 5, width = 5)


```


```{r}
library(ggtext)

davitts_ko <- data.frame(ko_type = c(rep(c("Short"),2), rep(c("Long"),2)),
                         ko_value = c(2,7,4,1,9,0,1,1),
                         ko_result = rep(c("Successful","Unsuccessful"), 4),
                         ko_half = c(rep(c("First Half"),4),rep(c("Second Half"),4))) %>%
  # Create ordered sequence for faceting
  mutate(facet_sequence = paste(ko_half, ko_type, sep = "_"),
         facet_sequence = factor(facet_sequence, 
                             levels = c("First Half_Short", "First Half_Long", 
                                       "Second Half_Short", "Second Half_Long")))

# davitts_df$Player <- factor(davitts_df$Player, levels = c("Dylan","Cathal","Jack","Shane"))
# 
# davitts_df$score_types <- factor(davitts_df$score_types, levels = c("Point", "2-Pointer","Goal","Miss"))
# 
# # Convert to tile coordinates
# waffle_coords <- waffle_iron(davitts_df, aes_d(fill = score_value, group = Player), rows = 11)
# 
# 
# count_df <- davitts_df %>%
#   mutate(id = row_number()) %>%
#   uncount(score_value) %>%
#   group_by(id) %>%
#   mutate(increment = row_number()) %>%
#   ungroup() %>%
#   group_by(Player) %>%
#   mutate(increment_final = row_number()) %>%
#   ungroup() %>%
#   mutate(score_text = case_when(score_types == "Point" ~ "1",
#                                 score_types == "2-Pointer" ~ "2",
#                                 score_types == "Goal" ~ "3",
#                                 score_types == "Miss" ~ NA,
#                                 T ~ NA)) %>%
#   # Create empty score value variable
#   mutate(score_value = NA)


```


```{r}

library(ggplot2)
library(waffle)

p <- ggplot(davitts_ko, aes(fill = ko_result, values = ko_value)) +
  geom_waffle(n_rows = 9, size = 1.5, colour = "white") +
  coord_equal() +
  facet_wrap(~ko_half, strip.position = "bottom") +
  # facet_grid(. ~ facet_sequence, 
  #            switch = "x",  # This moves the strip to the bottom
  #            labeller = labeller(facet_sequence = c(
  #                  "First Half_Short" = "1st Half - Short",
  #                  "First Half_Long" = "1st Half - Long",
  #                  "Second Half_Short" = "2nd Half - Short", 
  #                  "Second Half_Long" = "2nd Half - Long"))
  #            ) +
   scale_fill_manual(breaks = c("Successful","Unsuccessful"),
                     values = c("#379A8B","#DB444B")) +
  # geom_text(data = count_df, aes(x = 1, y = increment_final, label = score_text), 
  #           color = "black", family = "Lato", fontface = "bold", size = 4.5) +
  labs(title = paste0("<img src='/Users/andrewpeters/Desktop/Football_Projects/Davitts/Davitts_Crest.png' width='30'>", "Davitts Vs. Parke", "<img src='/Users/andrewpeters/Desktop/Football_Projects/Davitts/Parke.png' width='30'>"),
       subtitle = "Kickouts Taken by Davitts") +
  theme_void() +
  theme(panel.background = element_rect(color = "white", fill = "white"),
        plot.background = element_rect(color = "white", fill = "white"),
        panel.spacing = unit(4, "lines"),
        plot.title = element_markdown(color = "black", size = 28, family = "Lato", face = "bold"),
        plot.caption = element_markdown(color = "black", size = 10, family = "Lato"),
        plot.subtitle = element_text(size = 16, color = "gray30", family = "Lato"),
        strip.text = element_text(color = "gray20", size = 10, family = "Lato", margin = margin(t = -5, r = 0, b = 5, l = 0)),
        strip.clip = "off",
        # Legend
        legend.text = element_text(color = "gray20", size = 12, family = "Lato", hjust = 0),
        legend.title = element_blank(),
        legend.key = element_blank(),
        legend.margin=margin(5,0,0,0),
        #legend.box.margin=margin(0,0,-5,0),
        legend.position = "top")

p

ggsave(filename = '/Users/andrewpeters/Desktop/Football_Projects/Davitts/Kickouts.2.png', plot = p, dpi = 600, height = 5, width = 5)


```

```{r}

library(ggplot2)
library(waffle)
library(dplyr)

# Create base data
  df<- expand.grid(
    half = c("first", "second"),
    short_long = c("short", "long"),
    category = c("A", "B", "C", "D")
  ) %>%
    mutate(
      value = sample(1:20, n(), replace = TRUE),
      # Create ordered sequence for faceting
      facet_sequence = paste(half, short_long, sep = "_"),
      facet_sequence = factor(facet_sequence, 
                             levels = c("first_short", "first_long", 
                                       "second_short", "second_long"))
    )


ggplot(df, aes(fill = category, values = value)) +
      geom_waffle(color = "white", size = 0.25, n_rows = 5) +
      facet_grid(. ~ facet_sequence,
                 labeller = labeller(facet_sequence = c(
                   "first_short" = "First Half - Short",
                   "first_long" = "First Half - Long",
                   "second_short" = "Second Half - Short", 
                   "second_long" = "Second Half - Long"
                 ))) +
      scale_fill_brewer(name = "Category", palette = "Set2") +
      theme_void() +
      theme(
        strip.text.x = element_text(size = 12, margin = margin(b = 15)),
        strip.background = element_rect(fill = "lightgray", color = "black"),
        strip.placement = "outside",
        legend.position = "bottom",
        panel.spacing = unit(0.5, "lines")
      )

```

####### Rank ########


```{r}

Players_History <- read.csv('./24_25/Players_History.csv') 

FPL_ID <- '146709'

FPL_Team <- GET(paste0('https://fantasy.premierleague.com/api/entry/', FPL_ID, '/history/'))
    
    
    jsonRespText<-content(FPL_Team, as="text") 
    JSON_Output <- fromJSON(jsonRespText)
    
    Chips <- JSON_Output$chips %>%
      select(-time)
FPL_Team <- GET(paste0('https://fantasy.premierleague.com/api/entry/', FPL_ID,'/'))
    
    jsonRespText<-content(FPL_Team, as="text") 
    JSON_Output <- fromJSON(jsonRespText)
    Team_Name <- JSON_Output$name %>% data.frame() %>% pull(.)
    Manager <- paste0(JSON_Output$player_first_name, " ", JSON_Output$player_last_name) %>% data.frame() %>% pull(.)
    
    temp_df <- team_picks_parse(FPL_ID, max(Players_History$round)) %>%
      left_join(Chips, by = c('event')) %>%
      rename(chip = name) %>%
      mutate(chip_short = case_when(chip == 'wildcard' ~ 'WC',
                                    chip == 'freehit' ~ 'FH',
                                    chip == 'bboost' ~ 'BB',
                                    chip == '3xc' ~ 'TC',
                                    chip == 'manager' ~ 'AM',
                                    T ~'')) %>%
      mutate(GW_Chip = paste(event,"\n",chip_short)) %>%
      mutate(GW_Chip = str_replace(GW_Chip, " ",""))
    
    
    Team_Summary <- temp_df %>%
      #mutate(line_color = lead(overall_rank)) %>%
      mutate(line_color = lag(overall_rank)) %>%
      mutate(total_short = case_when(overall_rank >= 1000000 ~ paste0(round(overall_rank / 1000000, digits = 1), "M"),
                                     overall_rank < 1000 ~ as.character(overall_rank),
                                     T ~ paste0(round(overall_rank / 1000, digits = 0),"K"))) %>%
      mutate(movement = case_when(#line_color > overall_rank ~ "Red Arrow",
                                  #line_color < overall_rank ~ "Green Arrow",
                                  overall_rank > line_color ~ "Red Arrow",
                                  overall_rank < line_color~ "Green Arrow",
                                  T ~ "No Arrow"))
    
    small_df2 <- Team_Summary %>%
      filter(!is.na(chip))
    
    
    Names1 <- Team_Summary$GW_Chip
    Breaks1 <- Team_Summary$event
    
  



```


```{r}

data <- Team_Summary 

p <- ggplot(data, aes(x = event, y = overall_rank)) +
    geom_vline(data = small_df2, aes(xintercept = event), color = "lightgray", size = 9) +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "gray", alpha = 0.6) +
    geom_borderline(color = "gray60", size = 2, bordercolour = "#F3E9E2", borderwidth = 0.5, show.legend = F) +
    geom_point(aes(fill = movement), shape = 21, stroke = 1, size = 7, color = "#F3E9E2") +
    geom_text(aes(label = total_short), size = 1.8, fontface = "bold", family = "Lato", color = "white") +
    coord_cartesian(clip = "off") +
    scale_x_continuous(name = NULL, labels = setNames(Names1,Breaks1), breaks = Breaks1) +
    geom_hline(yintercept = 0) +
    scale_y_log10(labels = function(x) paste0(x / 1e6, "M")) +
    #scale_y_continuous(labels = function(x) paste0(x / 1e6, "M")) +
    scale_color_manual(breaks = c("Red Arrow","No Arrow","Green Arrow"),
                       values = c('#F2055C','gray60','#66C2A5')) +
    scale_fill_manual(breaks = c("Red Arrow","No Arrow","Green Arrow"),
                      values = c('#F2055C','gray60','#66C2A5')) +
    #labs(title =  paste0("<img src='./Logo4.png' width='30'>"," Gameweek Ranks (Current Rank: ", data %>% pull(overall_rank) %>% tail(1),")"),
    labs(title =  paste0("<img src='./Logo4.png' width='30'>"," Gameweek Ranks - ", Team_Name),
         caption = "Data Taken From FPL Website | Follow @Data_Vizard_<img src='./Logo4.png' width='13'>",
         subtitle = paste0("Overall Rank by Gameweek (Log Scale)"),
         color = "Team Name",
         fill = "Arrow Type") +
    xlab("Gameweek") +
    ylab("Overall Rank (Log Scale)") +
    #Adjust Theme to suit this plot
    theme(panel.grid.major.x = element_blank(),
          #panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_line(color = "lightgray", linewidth = 0.5),
          #panel.grid.major.y = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.border = element_blank(),
          panel.spacing = unit(0.5, "lines"),
          #panel.border = element_rect(colour = 'gray30', fill = NA, size = 2),
          legend.position = "top",
          panel.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
          plot.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
          plot.title = element_markdown(color = "black", size = 30, family = "Lato", face = "bold"),
          plot.caption = element_markdown(color = "black", size = 10, family = "Lato"),
          plot.subtitle = element_markdown(size = 22, color = "gray30", family = "Lato"),
          legend.text = element_text(color = "gray20", size = 16, family = "Lato", hjust = 0),
          legend.title = element_blank(),
          legend.key = element_blank(),
          legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(0,0,0,0),
          axis.text.x = element_text(color ="black", size = 12, family = "Lato"),
          axis.text.y = element_text(color ="black", size = 12, family = "Lato", vjust = -0.3, hjust = 1),
          #axis.text.y = element_markdown(size = 6, color = 'black', family = "Lato", hjust = 1),
          axis.title.x = element_text(color = "black", size = 12,  family = "Lato"),
          axis.title.y = element_blank(),
          axis.ticks.length.x = unit(0.1, "cm"),
          axis.ticks.x = element_blank(),
          axis.ticks.length.y = unit(0.1, "cm"),
          axis.ticks.y = element_blank(),
          axis.line.x = element_blank(),
          axis.line.y = element_blank(),
          strip.background = element_blank(),
          strip.text.x = element_markdown(color = "gray20", size = 12, family = "Lato"),
          strip.text.y.left = element_markdown(color = "gray20", size = 10, family = "Lato", angle = 360, vjust = 0),
          legend.background = element_blank())
  
  p


ggsave(filename = '/Users/andrewpeters/Desktop/FPL/FPL_Gallagher/rank1.png', plot = p, dpi = 600, height = 6, width = 10)

```

```{r}

Players_Gameweek <- read.csv('./24_25/Players_Gameweek.csv') 

FPL_ID <- '146709'

transfer_input <- "Yes"

    
    FPL_Team <- GET(paste0('https://fantasy.premierleague.com/api/entry/', FPL_ID, '/history/'))
    
    jsonRespText<-content(FPL_Team, as="text") 
    JSON_Output <- fromJSON(jsonRespText)
    
    Chips <- JSON_Output$chips %>%
      select(-time)
    
    
    tmp_df2 <- table2_parse(Players_Gameweek,FPL_ID)
    
    tmp_vec <- seq(1, max(Players_Gameweek$round),1)
    
    tmp_df <- data.frame(Gameweek = setdiff(tmp_vec, tmp_df2$Gameweek), 
                         chip = NA) %>%
      left_join(Chips, by = c('Gameweek' = 'event', 'chip' = 'name'))
    
    transfers <- bind_rows(tmp_df2, tmp_df)
    
    calculation1 <- transfer_input
    
    
    
    transfer_df <- transfers %>%
      #{if (input$transfer_input == "No") table2_parse(Players_Gameweek,input$team_id3) %>%
      #filter(., is.na(chip))
      #else table2_parse(Players_Gameweek,input$team_id3)} %>%
      {if(calculation1 == "No") filter(., !chip %in% c('wildcard','freehit')) else mutate(., chip = chip)} %>%
      mutate(movement = case_when(`Points Difference After Hits` <= -2  ~ "Poor",
                                  `Points Difference After Hits` >= 5 ~ "Good",
                                  T ~ "Average")) %>%
      left_join(Chips, by = c('Gameweek' = 'event', 'chip' = 'name')) %>%
      mutate(chip_short = case_when(chip == 'wildcard' ~ 'WC',
                                    chip == 'freehit' ~ 'FH',
                                    chip == 'bboost' ~ 'BB',
                                    chip == '3xc' ~ 'TC',
                                    chip == 'manager' ~ 'AM',
                                    T ~'')) %>%
      mutate(GW_Chip = paste(Gameweek,"\n",chip_short)) %>%
      mutate(GW_Chip = str_replace(GW_Chip, " ",""))
    
    
    small_df2 <- transfer_df %>%
      filter(!is.na(chip))
    
    
    FPL_Team <- GET(paste0('https://fantasy.premierleague.com/api/entry/', FPL_ID,'/'))
    
    jsonRespText<-content(FPL_Team, as="text") 
    JSON_Output <- fromJSON(jsonRespText)
    Team_Name <- JSON_Output$name %>% data.frame() %>% pull(.)
    Manager <- paste0(JSON_Output$player_first_name, " ", JSON_Output$player_last_name) %>% data.frame() %>% pull(.)
    
    Names1 <- transfer_df$GW_Chip
    Breaks1 <- transfer_df$Gameweek
    
    p <- transfer_plot(transfer_df, small_df2, Names1, Breaks1, 
                     Team_Name = "Test")
      
      
    p
      

```




```{r}

p <- ggplot(transfer_df, aes(x = Gameweek, y = `Points Difference After Hits`, color = as.factor(movement), fill = as.factor(movement))) +
    geom_vline(data = small_df2, aes(xintercept = Gameweek), color = "lightgray", size = 7) +
    geom_bar(stat = "identity", color = NA, width = 0.8) +
    #geom_segment(aes(x = Gameweek, xend = Gameweek, y = 0, yend = `Points Difference After Hits`), size = 3, show.legend = F) +
    geom_hline(yintercept = 0, color = "gray30", size = 0.75) +
    #geom_point(shape = 21, stroke = 1.25, size = 6, color = "#F3E9E2") +
    geom_text(aes(label = round(`Points Difference After Hits`, digits = 0)), size = 3, fontface = "bold", family = "Lato", nudge_y = 0.7) +
    geom_text(data = transfer_df %>% filter(`Points Difference After Hits` < 0), aes(label = round(`Points Difference After Hits`, digits = 0)), size = 3, fontface = "bold", family = "Lato", nudge_y = -0.7) +
    scale_color_manual(limits = c("Good","Average","Poor"),
                       #values = c('#66C2A5','#FFBF00','#F2055C'),
                       values = c('#379A8B','#006BA2','#DB444B')) +
    scale_fill_manual(limits = c("Good","Average","Poor"),
                      #values = c('#66C2A5','#FFBF00','#F2055C'),
                      values = c('#379A8B','#006BA2','#DB444B')) +
    coord_cartesian(clip = "off") +
    #scale_x_continuous(breaks = seq(1,38,1)) +
    scale_x_continuous(name = NULL, labels = setNames(Names1,Breaks1), breaks = Breaks1) +
    #scale_y_reverse(limits = c(105,0)) +
    #ylim(0,105) +
    #scale_x_discrete() +
    labs(#title =  paste0("Captaincy Success (ID: ", id, ")"),
      title =  paste0("<img src='./Logo4.png' width='30'>", " Transfers - ", Team_Name),
      subtitle = "Points Difference After Hits",
      caption = "Data Taken From FPL Website | Follow @Data_Vizard_<img src='./Logo4.png' width='13'>",
      fill = "Points Difference After Hits",
      color = "Points Difference After Hits") +
    xlab("Gameweek") +
    ylab("Points Difference After Hits") +
    #Adjust Theme to suit this plot
    theme(panel.grid.major.x = element_blank(),
          #panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_line(color = "lightgray", linewidth = 0.5),
          #panel.grid.major.y = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.border = element_blank(),
          panel.spacing = unit(0.5, "lines"),
          #panel.border = element_rect(colour = 'gray30', fill = NA, size = 2),
          legend.position = "top",
          panel.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
          plot.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
          plot.title = element_markdown(color = "gray10", size = 14, family = "Lato", hjust = 0, face = "bold"),
          plot.subtitle = element_text(size = 12, color = "gray30", family = "Lato", hjust = 0),
          plot.caption = element_markdown(color = "black", size = 6, family = "Lato"),
          legend.title = element_blank(),
          legend.key = element_blank(),
          legend.text = element_text(color = "black", size = 8, family = "Lato", hjust = 0),
          legend.margin=margin(0,0,0,0),
          legend.box.margin=margin(0,0,0,0),
          axis.text.x = element_text(color ="black", size = 6, family = "Lato"),
          axis.text.y = element_text(color ="black", size = 6, family = "Lato", vjust = -0.3, hjust = 1),
          #axis.text.y = element_markdown(size = 6, color = 'black', family = "Lato", hjust = 1),
          axis.title.x = element_text(color = "black", size = 12,  family = "Lato"),
          axis.title.y = element_blank(),
          axis.ticks.length.x = unit(0.1, "cm"),
          axis.ticks.x = element_blank(),
          axis.ticks.length.y = unit(0.1, "cm"),
          axis.ticks.y = element_blank(),
          axis.line.x = element_blank(),
          axis.line.y = element_blank(),
          strip.background = element_blank(),
          strip.text.x = element_markdown(color = "gray20", size = 12, family = "Lato"),
          strip.text.y.left = element_markdown(color = "gray20", size = 10, family = "Lato", angle = 360, vjust = 0),
          legend.background = element_blank())

p

#ggsave(filename = '/Users/andrewpeters/Desktop/FPL/FPL_Gallagher/transfers.png', plot = p, dpi = 600, height = 6, width = 10)
ggsave(filename = '/Users/andrewpeters/Desktop/FPL/FPL_Gallagher/transfers.2.png', plot = p, dpi = 600)

```

```{r}

source('/Users/andrewpeters/Desktop/Shiny_Apps/Test_Mobile/Mobile_Functions.R')
Players_History <- read.csv('/Users/andrewpeters/Desktop/Shiny_Apps/Test_Mobile/24_25/Players_History.csv')

Minutes_Data <- team_parse(data = Players_History,
                                   start_gameweek = 23, 
                                   end_gameweek = 26, 
                                   team_minutes = 0,
                                   team_name = "LIV")

Minutes_Data$Minutes_Type <- ordered(Minutes_Data$Minutes_Type, levels = c("90 Minutes","60 Minutes & Over","Under 60 Minutes"))
Minutes_Data$Points_Type <- ordered(Minutes_Data$Points_Type, levels = c("Minus","Blank","Return","Double Digit"))
Minutes_Data$Position <- ordered(Minutes_Data$Position, levels = c("GK","DEF","MID","ST"))


p <- team_gw_plot(input_metrics = "Minutes", 
                        data = Minutes_Data,
                        team_name = "LIV")


p


```

```{r}

p <- team_gw_plot(input_metrics = "Minutes", 
                        data = Minutes_Data,
                        team_name = "ARS")
      
p
  
```

```{r}

players_slider <- 12
all_metrics <- "all_xgi"

source('/Users/andrewpeters/Desktop/Shiny_Apps/Test_Mobile/Mobile_Functions.R')
Players_History <- read.csv('/Users/andrewpeters/Desktop/Shiny_Apps/Test_Mobile/24_25/Players_History.csv')

Minutes_Data <- team_parse_pos(data = Players_History,
                                  start_gameweek = 30, 
                                   end_gameweek = 38, 
                                   team_minutes = 0,
                                   position_name = "ST")
      
      subset_df <- Minutes_Data %>%
        select(name_club, round, all_metrics) %>%
        group_by(name_club, round) %>%
        mutate(count = n()) %>%
        summarise(all_metrics = unique(get(all_metrics)),
                  count = unique(count)) %>%
        #ungroup() %>%
        mutate(gw = case_when(count == 1 ~ "Single Gameweek",
                              count == 2 ~ "Double Gameweek",
                              T ~ "Test")) %>%
        as.data.frame() %>%
        arrange(desc(get(all_metrics))) %>%
        head(players_slider)
      
      Minutes_Data <- Minutes_Data %>%
        filter(name_club %in% subset_df$name_club)
      
      Minutes_Data$Minutes_Type <- ordered(Minutes_Data$Minutes_Type, levels = c("90 Minutes","60 Minutes & Over","Under 60 Minutes"))
      Minutes_Data$Points_Type <- ordered(Minutes_Data$Points_Type, levels = c("Minus","Blank","Return","Double Digit"))
      Minutes_Data$Position <- ordered(Minutes_Data$Position, levels = c("GK","DEF","MID","ST"))

      
```



```{r}

source('/Users/andrewpeters/Desktop/Shiny_Apps/Test_Mobile/Mobile_Functions.R')
Players_History <- read.csv('/Users/andrewpeters/Desktop/Shiny_Apps/Test_Mobile/24_25/Players_History.csv')

Minutes_Data <- team_parse_pos(data = Players_History,
                                   start_gameweek = 18, 
                                   end_gameweek = 26, 
                                   team_minutes = 0,
                                   position_name = "ST") %>%
  arrange(desc(all_xgi))

subset_df <- Minutes_Data %>%
  select(name_club, all_xgi) %>%
  unique() %>%
  head(20) %>%
  pull(name_club)

Minutes_Data <- Minutes_Data %>%
  filter(name_club %in% subset_df)
                               #player_number = 20)


Minutes_Data$Minutes_Type <- ordered(Minutes_Data$Minutes_Type, levels = c("90 Minutes","60 Minutes & Over","Under 60 Minutes"))
Minutes_Data$Points_Type <- ordered(Minutes_Data$Points_Type, levels = c("Minus","Blank","Return","Double Digit"))
Minutes_Data$Position <- ordered(Minutes_Data$Position, levels = c("GK","DEF","MID","ST"))

data <- Minutes_Data

       y_var <- "all_xa"
        text_var <- "xa"
        col_var <- "xa_Type"
        color_palette <- scale_fill_manual(breaks = c("Anonymous","Not Involved","Involved","Very Involved"),
                                           values = c('#DB444B','#3EBCD2','#006BA2','#379A8B'))
        scale1 <- scale_y_reordered(labels = setNames(paste0(data$name, " (", data$all_xa," xA)"),  paste0(data$Position,"___",data$name)),
                                    position = "right")
        text_labels <- geom_text(aes(label = get(text_var)), color = "#F3E9E2", family = "Lato", size = 1.7, fontface = "bold", show.legend = F)

     
     



p <- ggplot(data, aes(x = round, y = reorder_within(Position, get(y_var), name), fill = get(col_var), colour = get(col_var))) +
     geom_point(shape = 22, color = "#F3E9E2", size = 6) +
     text_labels +
     facet_grid(Position ~., scales = "free", space = "free", switch = "y") +
     color_palette +
     scale1 +
  scale_x_continuous(breaks = seq(1,38)) +
     #scale_x_discrete(name = NULL, labels = setNames(as.character(data$opp_name), data$opp_team)) +
     xlab('FPL Gameweeks') +
     ylab('Player Names') +
     labs(title = "Test Title",
          #title = paste0("<img src='./Logo4.png' width='30'> ", team_name, " | Player ", input_metrics, " Matrix"),
          #subtitle = "Cumulative Points Totals For the Highest Scoring FPL Players",
          #caption = "Data Taken From FPL Website | Follow @Data_Vizard_<img src='./Logo4.png' width='13'>",
          size = 'Number Of Starts',
          fill = 'Appearance Type') +
     #guides(fill = guide_legend(override.aes = list(size = 10))) +
     #Adjust Theme to suit this plot
     theme(#panel.grid.major.x = element_line(color = "gray", linewidth = 1, linetype = 'dotted'),
       panel.grid.major.x = element_blank(),
       #panel.grid.major.y = element_line(color = "#D8D9DA", linewidth = 1),
       panel.grid.major.y = element_line(color = "gray", linewidth = 0.5),
       panel.grid.minor.x = element_blank(),
       panel.grid.minor.y = element_blank(),
       panel.border = element_blank(),
       panel.spacing = unit(0.5, "lines"),
       #panel.border = element_rect(colour = 'gray30', fill = NA, size = 2),
       legend.position = "top",
       panel.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
       plot.background = element_rect(color = "#F3E9E2", fill = "#F3E9E2"),
       plot.title = element_markdown(color = "gray10", size = 14, family = "Lato", hjust = 0, face = "bold"),
       plot.subtitle = element_text(size = 12, color = "gray30", family = "Lato", hjust = 0),
       plot.caption = element_markdown(color = "black", size = 6, family = "Lato"),
       legend.text = element_text(color = "black", size = 8, family = "Lato", hjust = 0),
       legend.title = element_blank(),
       #legend.key = element_blank(),
       #legend.key.height= unit(0.1, 'cm'),
       #legend.key.width= unit(0.1, 'cm'),
       legend.key.size = unit(0.1, 'cm'),
       legend.margin=margin(0,0,0,0),
       legend.box.margin=margin(0,0,0,0),
       axis.text.x = element_text(color ="black", size = 6, family = "Lato"),
       #axis.text.x = element_markdown(color ="black", size = 10, family = "Lato"),
       axis.text.y = element_text(color ="black", size = 6, family = "Lato", hjust = 0, face = 'bold'),
       #axis.text.y = element_markdown(size = 6, color = 'black', family = "Lato", hjust = 1),
       axis.title.x = element_text(color = "black", size = 12,  family = "Lato", face = 'bold'),
       axis.title.y = element_blank(),
       axis.ticks.x = element_blank(),
       axis.ticks.y = element_blank(),
       axis.line.x = element_blank(),
       axis.line.y = element_line(color = "gray30", size = 0.7),
       strip.background = element_blank(),
       strip.text.x = element_markdown(color = "gray20", size = 6, family = "Lato", face = "bold"),
       strip.text.y.left = element_markdown(color = "gray20", size = 8, family = "Lato", angle = 90, face = "bold"),
       legend.background = element_blank())   
   
   p


```

